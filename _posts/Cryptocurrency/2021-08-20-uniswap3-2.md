---
layout: post
title: Uniswap 3 - Starting from Uniswap v1
tags: [Cryptocurrency, Decentralized Finance]
category: ["Cryptocurrency & DeFi"]
banner: "/assets/images/banners/UniswapBackground.jpg"
---

## Uniswap v1 æ˜¯ä»€ä¹ˆ

Source

* [The Uniswap V1 Protocol](https://docs.uniswap.org/protocol/V1/introduction)
* [ERC-20 Token Standard](https://ethereum.org/en/developers/docs/standards/tokens/erc-20/)



Uniswap æ˜¯ç”±ä¸€ç³»åˆ— [ETH-ERC20](https://ethereum.org/en/developers/docs/standards/tokens/erc-20/) äº¤æ¢åè®®æ„æˆçš„

> *ä»€ä¹ˆæ˜¯ ERC20 ä»£å¸ï¼Ÿ*
>
> ETH-ERC20 æ˜¯ä¸€ç§æè¿°å¯äº¤æ¢ä»£å¸çš„ä»¥å¤ªåŠæ ‡å‡†
>
> è¿™ä¸ªæ ‡å‡†ä¸ºä»¥å¤ªåŠä¸Šçš„å¯äº¤æ¢ä»£å¸çš„æ™ºèƒ½åˆçº¦æä¾›äº†ç»Ÿä¸€çš„ API - Link: [ERC-20 Token Standard](https://ethereum.org/en/developers/docs/standards/tokens/erc-20/)

### å¦‚ä½•ä½¿ç”¨ Uniswap Factory ä¸º ERC20 ç”Ÿæˆ Uniswap Protocal

æ¯ç§ ERC20 ä»£å¸æœ‰ä¸”åªæœ‰ä¸€ä¸ª Uniswap åè®®ã€‚å¦‚æœä¸€ç§ä»£å¸æ²¡æœ‰ Uniswap åè®®ï¼Œä»»ä½•äººå¯ä»¥ä½¿ç”¨ Uniswap factory contract æ¥ä¸ºä»£å¸ç”Ÿæˆä¸€ä¸ª Uniswap åè®®ã€‚

### æµåŠ¨æ€§è´¡çŒ®è€…çš„è´¡çŒ®æ¯”ä¾‹è®¡ç®—æ–¹å¼

æ¯ä¸€ä¸ªæ™ºèƒ½åˆçº¦ä¼šä¿å­˜ä»¥å¤ªåŠå’Œç›¸å…³è”çš„ ERC20 ä»£å¸ã€‚æ¯ä¸ªäººéƒ½å¯ä»¥é€šè¿‡å‘æ™ºèƒ½åˆçº¦è´¡çŒ®èµ„äº§æˆä¸ºæµåŠ¨æ€§è´¡çŒ®è€…ä¹‹ä¸€ã€‚ä¸ä¸€èˆ¬çš„ä¹°å–åŒæ–¹å¸‚åœºä¸åŒï¼ŒæµåŠ¨æ€§è´¡çŒ®è€…éœ€è¦æä¾›**ç­‰ä»·çš„**ä»¥å¤ªåŠå’Œ ERC20 ä»£å¸ã€‚ä¸€ç§å†…ç½®çš„ ERC20 ä»£å¸ ï¼ˆæ± å­å¸, Pool Tokenï¼‰è¢«ç”¨æ¥è®°å½•æ¯ä¸ªæµåŠ¨æ€§è´¡çŒ®è€…çš„è´¡çŒ®æ¯”ä¾‹ã€‚

* å½“æµåŠ¨æ€§è´¡çŒ®è€…å°†èµ„äº§åŠ å…¥ Uniswap æµåŠ¨æ€§æ± å­æ—¶ï¼Œæ± å­å¸ä¼šè¢«â€œé“¸é€  (mint) â€

* å½“æµåŠ¨æ€§è´¡çŒ®è€…å°†èµ„äº§ä»æµåŠ¨æ€§æ± å­ä¸­å–å‡ºæ—¶ï¼Œæ± å­å¸ä¼šè¢«â€œé”€æ¯ (burn) â€

## Uniswap v1 æ˜¯å¦‚ä½•å·¥ä½œçš„

Sources

* [ğŸ¦„ Uniswap Whitepaper - HackMD](https://hackmd.io/@HaydenAdams/HJ9jLsfTz?type=view)

### ETH â‡„ ERC20 Token äº¤æ˜“

æ¯ä¸€ä¸ª ETHâ‡„ERC20 çš„æµåŠ¨æ€§æ± å­éƒ½ç”±ä¸€ä¸ª Uniswap åè®®æ§åˆ¶ï¼ŒUniswap åè®®çº¦æŸæµåŠ¨æ€§æ± å­ä¸­çš„ ETH ä¸ ERC20 èµ„äº§ä¹‹ä¹˜ç§¯æ˜¯ä¸€å®šçš„ã€‚

```
sizeof(eth_pool) * sizeof(token_pool) = K, where K is constant
```

**ä¾‹å­ï¼š**

> ä¸€ä¸ª Uniswap æµåŠ¨æ€§æ± å­ä¸­ï¼Œæœ‰æµåŠ¨æ€§æä¾›è€…ä¾›ç»™çš„ 10 ETH å’Œ 500 OMG ï¼ˆä¸€ç§ ERC20ï¼‰ä»£å¸ã€‚æ¯ä¸€æ¬¡è‡ªåŠ¨åšå¸‚å•†AMMçš„äº¤æ˜“éƒ½ä¼šæ”¶å– 0.3% çš„æ‰‹ç»­è´¹

$$
\text{ETH pool}\times \text{OMG pool} = K
$$

$$
K=ETH \times OMG = 10 \times 500 = 5000
$$

è¿™æ—¶å€™ï¼Œä¸€ä¸ªäº¤æ˜“è€…å‘æµåŠ¨æ€§æ± å­ç»™å‡º `1 ETH`

1. ä¹°æ–¹ç»™å‡º 1 ETH

2. æ‰‹ç»­è´¹ = 1 ETH * 0.3% = 0.00333 ETH

3. æµåŠ¨æ€§æ± å­ä¸­çš„ä»¥å¤ªåŠèµ„äº§ = 10 ETH + 1 ETH - 0.00333 ETH = 10.99667 ETH
4. æµåŠ¨æ€§æ± å­ä¸­åº”æœ‰çš„ ERC20 èµ„äº§ = 5000 / 10.99667 = 454.68309 OMG
5. åº”è¯¥ç»™åˆ°ä¹°æ–¹çš„  ERC20 èµ„äº§ = 500 - 454.68309 = 45.31691 OMG

è¿™æ—¶å€™æµåŠ¨æ€§æ± å­å·²ç»è¾¾åˆ°äº†æ–°çš„å¹³è¡¡ (K = 5000)ï¼Œç„¶åæˆ‘ä»¬æŠŠ ETH çš„æ‰‹ç»­è´¹è‡ªåŠ¨æ³¨å…¥æµåŠ¨æ€§æ± å­â€¦â€¦

6. æµåŠ¨æ€§æ± å­ä¸­çš„ä»¥å¤ªåŠèµ„äº§ = 10.99667 ETH + 0.00333 ETH = 11 ETH
7. æ–°çš„ä¹˜ç§¯å¸¸æ•° = 11 ETH * 454.68309 OMG = 5001.51399

å¯ä»¥çœ‹åˆ°ï¼Œéšç€æ‰‹ç»­è´¹çš„æ³¨å…¥ï¼Œæ± å­çš„è§„æ¨¡åˆæ‰©å¤§äº†ä¸€ç‚¹ã€‚

![1cd6fa72fdd28df10cccfc91c7409bf](https://markdown-img-1304853431.file.myqcloud.com/20210809225021.jpg)

### ERC20 â‡„ ERC20 äº¤æ˜“

![img](https://i.imgur.com/0yDILRq.png)

å½“ä½¿ç”¨ Uniswap äº¤æ¢ä¸¤ç§ ERC20 Token æ—¶ï¼Œ Uniswap ä¼šå°†ç¬¬ä¸€ç§ token æ¢æˆ ETHï¼Œå†åœ¨ç¬¬äºŒä¸ªæ± ä¸­å°† ETH æ¢æˆç¬¬äºŒç§ ERC20 Token

### äº¤æ¢(Swap) vs è½¬æ¢(Transfer)

`Swap` ä¼šå°†å…‘æ¢åçš„ç»“æœç›´æ¥è¿”å›ç»™åŸè´¦æˆ·

`Transfer` å¯ä»¥å°†å…‘æ¢å®Œçš„ ERC20 Token ç»™åˆ°æŒ‡å®šçš„æ–°è´¦æˆ·

## æä¾›æµåŠ¨æ€§

### å¢åŠ æµåŠ¨æ€§

æ·»åŠ æµåŠ¨æ€§éœ€è¦å‘ ERC20 Token çš„ Uniswap åˆçº¦æ·»åŠ ç›¸åŒ¹é…çš„ ETH å’Œ ERC20 ä»£å¸ã€‚

å‰æ–‡æåˆ° Uniswap V1 ä½¿ç”¨ Pool Token ï¼ˆä¸€ç§ ERC20 Tokenï¼‰æ¥è®¡ç®—æµåŠ¨æ€§æ± å­ä¸­æ¯ä¸€ä¸ªæµåŠ¨æ€§æä¾›è€…çš„è´¡çŒ®ã€‚

Uniswap v1 ä¸­å‘åˆçº¦æ³¨å…¥èµ„äº§çš„ [Py-EVM](https://github.com/ethereum/py-evm) ä»£ç 

```python
@public
@payable
def addLiquidity():
    token_amount: uint256 = msg.value * token_pool / eth_pool 
    liquidity_minted: uint256 = msg.value * total_liquidity / eth_pool
        
        
    eth_added: uint256 = msg.value
    shares_minted: uint256 = (eth_added * self.total_shares) / self.eth_pool
    tokens_added: uint256 = (shares_minted * self.token_pool) / self.total_shares)
    self.shares[msg.sender] = self.shares[msg.sender] + shares_minted
    self.total_shares = self.total_shares + shares_minted
    self.eth_pool = self.eth_pool + eth_added
    self.token_pool = self.token_pool + tokens_added
    self.token.transferFrom(msg.sender, self, tokens_added)
```

æ¯æ¬¡å‘ Uniswap åˆçº¦æ³¨å…¥èµ„äº§æ—¶éƒ½ä¼šè§¦å‘ Pool Token çš„é“¸é€ ï¼ˆMintï¼‰ï¼ŒPool Token çš„é“¸é€ æ•°é‡éµå¾ªæ­¤å…¬å¼ï¼š

$$
amountMint=TotalAmount * \frac{ethDeposited}{ethPool}
$$

å‘ Uniswap åˆçº¦æ³¨å…¥ ETH å’Œ ERC20 å**å¿…é¡»**ç»´æŒåˆçº¦çš„ä¹˜ç§¯æ’ç­‰å¼ï¼Œæ‰€ä»¥åº”è¯¥æ³¨å…¥çš„ ERC20 æ•°é‡å¯ä»¥è¿™æ ·è®¡ç®—ï¼š

$$
tokensDeposited = tokenPool * \frac{ethDeposited}{ethPool}
$$

### ç§»é™¤æµåŠ¨æ€§

å½“æµåŠ¨æ€§æä¾›è€…ä» Uniswap åˆçº¦ä¸­æ’¤å›è‡ªå·±æŠ•å…¥çš„èµ„äº§æ—¶ï¼Œæˆ‘ä»¬ç§°å…¶â€œç§»é™¤äº†æµåŠ¨æ€§â€

å½“æµåŠ¨æ€§è¢«ç§»é™¤æ—¶, Pool Token ä¼šè¢«ç„šæ¯ (Burn)

